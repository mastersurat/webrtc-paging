<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>üéß ‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h1>
  <audio id="player" autoplay playsinline muted></audio>
  <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...</p>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/config.js"></script>
  <script>
    const socket = io();
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");

    const iceConfig = window.ICE_CONFIG || { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    console.log("ICE(user):", iceConfig);

    let pc=null;

    function initPC(){
      const _pc=new RTCPeerConnection(iceConfig);
      _pc.ontrack=e=>{
        console.log("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö audio track");
        player.srcObject=e.streams[0];
        player.muted=false;
        statusEl.textContent="‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏¢‡∏π‡πà...";
      };
      _pc.onicecandidate=e=>{
        if(e.candidate) socket.emit("ice-candidate-to-broadcaster",{candidate:e.candidate});
      };
      _pc.onconnectionstatechange=()=>console.log("PC(user) state:", _pc.connectionState);
      return _pc;
    }

    window.addEventListener("load",()=>{
      statusEl.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
      pc=initPC();
      socket.emit("watcher-join");
    });

    socket.on("offer",async({sdp})=>{
      if(!pc)pc=initPC();
      await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.emit("watcher-answer",{sdp:ans});
      console.log("‡∏™‡πà‡∏á answer ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ admin ‡πÅ‡∏•‡πâ‡∏ß");
    });

    socket.on("ice-candidate",({candidate})=>{
      if(pc&&candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on("broadcast-offline",()=>{
      statusEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì";
      if(pc){pc.close();pc=null;}
    });
  </script>
</body>
</html>
