<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Admin Paging</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>üì£ Admin Paging</h1>
  <input id="key" placeholder="ADMIN_KEY" />
  <button id="loginBtn">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô Admin</button>
  <p id="loginStatus"></p>
  <button id="muteBtn" disabled>‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
  <p>‡∏ú‡∏π‡πâ‡∏ü‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: <span id="count">0</span></p>
  <audio id="monitor" controls></audio>
  <p id="note"></p>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/config.js"></script>
  <script>
    const socket = io();
    const pcMap = new Map();
    let localStream = null, micTrack = null;

    const iceConfig = window.ICE_CONFIG || { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    console.log("ICE(admin):", iceConfig);

    loginBtn.onclick = async () => {
      socket.emit("register-broadcaster", key.value.trim(), async res => {
        if (res.ok) {
          loginStatus.textContent = "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå...";
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              audio: { echoCancellation: true, noiseSuppression: true },
              video: false
            });
            micTrack = localStream.getAudioTracks()[0];
            monitor.srcObject = localStream; 
            monitor.muted = true;
            muteBtn.disabled = false; 
            note.textContent = "‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
          } catch (err) { 
            console.error(err);
            note.textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message; 
          }
        } else loginStatus.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î";
      });
    };

    muteBtn.onclick = () => {
      if(micTrack){
        micTrack.enabled = !micTrack.enabled;
        muteBtn.textContent = micTrack.enabled ? "‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå";
      }
    };

    socket.on("watcher-join", async wid => {
      if (!micTrack) return;
      console.log("watcher-join:", wid);
      const pc = new RTCPeerConnection(iceConfig);
      pc.onicecandidate = e => {
        if(e.candidate) socket.emit("ice-candidate-to-watcher",{watcherId:wid,candidate:e.candidate});
      };
      pc.onconnectionstatechange = () => console.log("PC(admin)->", wid, pc.connectionState);
      pc.addTrack(micTrack, localStream);
      console.log("‡∏™‡πà‡∏á mic track ‡πÑ‡∏õ‡∏¢‡∏±‡∏á watcher:", wid);
      pcMap.set(wid, pc);
      const offer = await pc.createOffer(); 
      await pc.setLocalDescription(offer);
      socket.emit("offer-to-watcher", { watcherId: wid, sdp: offer });
    });

    socket.on("watcher-answer", async ({ watcherId, sdp }) => {
      const pc=pcMap.get(watcherId); 
      if(pc) {
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        console.log("‡πÑ‡∏î‡πâ answer ‡∏à‡∏≤‡∏Å watcher:", watcherId);
      }
    });

    socket.on("ice-candidate-from-watcher", ({ watcherId, candidate }) => {
      const pc=pcMap.get(watcherId); 
      if(pc&&candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on("watcher-left", wid => {
      const pc=pcMap.get(wid); 
      if(pc) pc.close(); 
      pcMap.delete(wid);
    });

    socket.on("watcher-count", n => count.textContent=n);
  </script>
</body>
</html>
